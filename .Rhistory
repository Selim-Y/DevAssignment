diff_p       <- s$coef["freebooks","Pr(>|t|)"]
# prepare and print compact table
tab <- data.frame(
group = c("Control (freebooks=0)", "Treatment (freebooks=1)", "Difference (T - C)"),
proportion = c(control_mean, treat_mean, diff_est),
se = c(NA, NA, diff_se),
p_value = c(NA, NA, diff_p),
stringsAsFactors = FALSE
)
tab$percent <- round(100 * tab$proportion, 2)
tab$se_pct  <- ifelse(is.na(tab$se), NA, round(100 * tab$se, 2))
cat("\nEffect of free books on later enrollment (inschool_later) — Tanzania_2018_new-3.dta\n")
print(tab[, c("group","percent","se_pct","p_value")], row.names = FALSE)
# keep observations with treatment and outcome
d <- subset(d, !is.na(freebooks) & !is.na(inschool_later))
if (nrow(d) == 0) stop("No observations with freebooks and inschool_later.")
# survey design: use STRATUM if present, otherwise unstratified
if ("STRATUM" %in% names(d)) {
svy <- svydesign(id = ~1, strata = ~STRATUM, weights = ~hhweight, data = d)
} else {
svy <- svydesign(id = ~1, weights = ~hhweight, data = d)
}
# group means (proportions) by freebooks (0 = control, 1 = treatment)
grp <- svyby(~inschool_later, ~freebooks, svy, svymean, na.rm = TRUE)
# difference in means via linear survey regression (identity link)
fit <- svyglm(inschool_later ~ freebooks, design = svy, family = gaussian())
s <- summary(fit)
# extract numbers
control_mean <- as.numeric(grp$inschool_later[grp$freebooks == 0])
treat_mean   <- as.numeric(grp$inschool_later[grp$freebooks == 1])
diff_est     <- coef(fit)["freebooks"]
diff_se      <- s$coef["freebooks","Std. Error"]
diff_p       <- s$coef["freebooks","Pr(>|t|)"]
# prepare and print compact table
tab <- data.frame(
group = c("Control (freebooks=0)", "Treatment (freebooks=1)", "Difference (T - C)"),
proportion = c(control_mean, treat_mean, diff_est),
se = c(NA, NA, diff_se),
p_value = c(NA, NA, diff_p),
stringsAsFactors = FALSE
)
tab$percent <- round(100 * tab$proportion, 2)
tab$se_pct  <- ifelse(is.na(tab$se), NA, round(100 * tab$se, 2))
cat("\nEffect of free books on later enrollment (inschool_later) — Tanzania_2018_new-3.dta\n")
print(tab[, c("group","percent","se_pct","p_value")], row.names = FALSE)
# keep observations with treatment and outcome
d <- subset(d, !is.na(freebooks) & !is.na(inschool_later))
if (nrow(d) == 0) stop("No observations with freebooks and inschool_later.")
# survey design: use STRATUM if present, otherwise unstratified
if ("STRATUM" %in% names(d)) {
svy <- svydesign(id = ~1, strata = ~STRATUM, weights = ~hhweight, data = d)
} else {
svy <- svydesign(id = ~1, weights = ~hhweight, data = d)
}
# group means (proportions) by freebooks (0 = control, 1 = treatment)
grp <- svyby(~inschool_later, ~freebooks, svy, svymean, na.rm = TRUE)
# difference in means via linear survey regression (identity link)
fit <- svyglm(inschool_later ~ freebooks, design = svy, family = gaussian())
s <- summary(fit)
# extract numbers
control_mean <- as.numeric(grp$inschool_later[grp$freebooks == 0])
treat_mean   <- as.numeric(grp$inschool_later[grp$freebooks == 1])
diff_est     <- coef(fit)["freebooks"]
diff_se      <- s$coef["freebooks","Std. Error"]
diff_p       <- s$coef["freebooks","Pr(>|t|)"]
# prepare and print compact table
tab <- data.frame(
group = c("Control (freebooks=0)", "Treatment (freebooks=1)", "Difference (T - C)"),
proportion = c(control_mean, treat_mean, diff_est),
se = c(NA, NA, diff_se),
p_value = c(NA, NA, diff_p),
stringsAsFactors = FALSE
)
tab$percent <- round(100 * tab$proportion, 2)
tab$se_pct  <- ifelse(is.na(tab$se), NA, round(100 * tab$se, 2))
cat("\nEffect of free books on later enrollment (inschool_later)\n")
print(tab[, c("group","percent","se_pct","p_value")], row.names = FALSE)
# First we need to make sure that some packages (=places where e.g. commands are
#saved) are available, for this, we need to install them
#for this, we create a variable called check, (see in your Enviroment
#what value it takes after having run the line), it takes TRUE if the package is
#already installed and FALSE if not
check <- require('survey')
#next, we have a loop that has a condition (!check, this condition is TRUE if check is FALSE and FALSE if check is TRUE)
#i.e. if it is already installed, the loop will not do anything, if it is not instaled, it will install it
#Depending on your version, you might need to enter YES in the console to confirm that you want to install it
if(!check) {
install.packages('survey')
}
#just because it is installed does not mean that it is loaded into your current session (the one you run this file in), therefore we execute the following code
library(survey)
#to learn about the package
?survey
#now to the next package that will allow us to load the files we have easily into R
check <- require('readstata13')
#if not installed, install the package, this needs to be confirmed by typing in yes in the command console, after having run the following line
if(!check) {
install.packages('readstata13')
}
library('readstata13')
#to learn about the package
?readstata13
#some housekeeping
rm(check)
# now finally: Read in data
#for this: we create the filepath either per hand, see the line below,
#or we use the point-and-shoot-option (often easier if you donot feel comfortable with R or coding yet)
# statafile <- 'u:/interim files/Tanzania 2012.dta' #if you want to use this, delete the # at the beginning and type in the correct path
statafile <- file.choose() #allows for clicking on it in a window, no need to have the path ready
files <- c("Datasets/Tanzania_2012.dta", "Datasets/Tanzania_2018.dta")
for (f in files) {
df <- read_dta(f)
}
# basic checks
if (!"cons" %in% names(df)) {
message("Skipping ", f, ": 'cons' not found.")
next
}
if (!"povline" %in% names(df)) {
message("Skipping ", f, ": 'povline' not found.")
next
}
# make indicator: 1 if cons < povline, 0 otherwise; keep NA where input NA
df$below_pov <- ifelse(is.na(df$cons) | is.na(df$povline), NA,
ifelse(df$cons < df$povline, 1, 0))
# quick summary
n_total <- sum(!is.na(df$below_pov))
n_below <- sum(df$below_pov == 1, na.rm = TRUE)
prop_below <- if (n_total > 0) n_below / n_total else NA
cat("\nFile:", f, "\n")
cat("Observations with cons & povline:", n_total, "\n")
cat("Households below poverty line:", n_below, "\n")
cat("Share below poverty line:", round(prop_below, 4), "\n")
# save
out_csv <- sub("\\.dta$", "_with_poverty.csv", basename(f))
write.csv(df, out_csv, row.names = FALSE)
cat("Saved:", out_csv, "\n")
d <- read_dta("Datasets/Tanzania_2018_new-3.dta")
# below-poverty households and valid observations in age 7-18
sel <- (d$cons < d$povline) & !is.na(d$inschool) & !is.na(d$male) & !is.na(d$rural) & !is.na(d$age) & d$age >= 7 & d$age <= 18
d <- d[sel, , drop = FALSE]
if (nrow(d) == 0) stop("No observations in below-poverty households aged 7-18 with required vars.")
# create age group variable
d$agegrp <- ifelse(d$age >= 7 & d$age <= 12, "7-12", "13-18")
# survey design using household weight
svy <- svydesign(id = ~1, weights = ~hhweight, data = d)
# weighted mean of inschool by rural + male + agegrp
res <- svyby(~inschool, ~rural + male + agegrp, svy, svymean, na.rm = TRUE)
# identify estimate and se columns robustly
group_cols <- c("rural","male","agegrp")
est_col <- setdiff(names(res), group_cols)[1]
se_col_candidates <- grep(paste0("^", est_col, "(_se|\\.se$|__se$)"), names(res), value = TRUE)
if (length(se_col_candidates) == 0) se_col_candidates <- grep("(_se$|\\.se$|se$)", names(res), value = TRUE)
se_col <- if (length(se_col_candidates) > 0) se_col_candidates[1] else NA
# build result frame and labels
res_df <- data.frame(
rural = res$rural,
male = res$male,
agegrp = res$agegrp,
estimate = res[[est_col]],
se = if (!is.na(se_col)) res[[se_col]] else NA_real_,
stringsAsFactors = FALSE
)
# map codes to readable labels
res_df$location <- ifelse(res_df$rural %in% c(1, "1", TRUE), "rural", "urban")
res_df$sex_label <- ifelse(res_df$male %in% c(1, "1", TRUE), "Male", "Female")
res_df$percent <- 100 * res_df$estimate
res_df$se_pct  <- 100 * res_df$se
res_df$display <- ifelse(is.na(res_df$percent), NA, sprintf("%.1f (±%.1f)", res_df$percent, res_df$se_pct))
# create column name combining sex and age group, then pivot wide (base R)
res_df$colname <- paste(res_df$sex_label, res_df$agegrp)
wide <- reshape(res_df[, c("location","colname","display")],
idvar = "location", timevar = "colname", direction = "wide")
names(wide) <- sub("^display\\.", "", names(wide))
# ensure order: urban then rural (rural variable uses 0 = urban, 1 = rural)
order_pref <- c("urban","rural")
wide$location <- factor(wide$location, levels = order_pref)
wide <- wide[order(wide$location, na.last = TRUE), , drop = FALSE]
# replace NA with "-"
wide[is.na(wide)] <- "-"
# print table (screenshot-friendly)
print(wide, row.names = FALSE)
if (interactive()) View(wide)
# keep observations with treatment and outcome
d <- subset(d, !is.na(freebooks) & !is.na(inschool_later))
if (nrow(d) == 0) stop("No observations with freebooks and inschool_later.")
# survey design: use STRATUM if present, otherwise unstratified
if ("STRATUM" %in% names(d)) {
svy <- svydesign(id = ~1, strata = ~STRATUM, weights = ~hhweight, data = d)
} else {
svy <- svydesign(id = ~1, weights = ~hhweight, data = d)
}
# group means (proportions) by freebooks (0 = control, 1 = treatment)
grp <- svyby(~inschool_later, ~freebooks, svy, svymean, na.rm = TRUE)
# difference in means via linear survey regression (identity link)
fit <- svyglm(inschool_later ~ freebooks, design = svy, family = gaussian())
s <- summary(fit)
# extract numbers
control_mean <- as.numeric(grp$inschool_later[grp$freebooks == 0])
treat_mean   <- as.numeric(grp$inschool_later[grp$freebooks == 1])
diff_est     <- coef(fit)["freebooks"]
diff_se      <- s$coef["freebooks","Std. Error"]
diff_p       <- s$coef["freebooks","Pr(>|t|)"]
# prepare and print compact table
tab <- data.frame(
group = c("Control (freebooks=0)", "Treatment (freebooks=1)", "Difference (T - C)"),
proportion = c(control_mean, treat_mean, diff_est),
se = c(NA, NA, diff_se),
p_value = c(NA, NA, diff_p),
stringsAsFactors = FALSE
)
tab$percent <- round(100 * tab$proportion, 2)
tab$se_pct  <- ifelse(is.na(tab$se), NA, round(100 * tab$se, 2))
cat("\nEffect of free books on later enrollment (inschool_later)\n")
print(tab[, c("group","percent","se_pct","p_value")], row.names = FALSE)
d <- read_dta("Datasets/Tanzania_2018_new-3.dta")
for (f in files) {
df <- read_dta(d)
}
d <- read_dta("Datasets/Tanzania_2018_new-3.dta")
df <- read_dta(d)
file_path <- "Datasets/Tanzania_2018_new-3.dta"
# make indicator: 1 if cons < povline, 0 otherwise; keep NA where input NA
df$below_pov <-   ifelse(df$cons < df$povline, 1, 0)
# quick summary
n_total <- sum(!is.na(df$below_pov))
n_below <- sum(df$below_pov == 1, na.rm = TRUE)
prop_below <- if (n_total > 0) n_below / n_total else NA
cat("File:", file_path, "\n")
cat("Observations with cons & povline:", n_total, "\n")
cat("Households below poverty line:", n_below, "\n")
cat("Share below poverty line:", round(prop_below, 4), "\n")
# save
out_csv <- sub("\\.dta$", "_with_poverty.csv", basename(file_path))
write.csv(df, out_csv, row.names = FALSE)
cat("Saved:", out_csv, "\n")
file_path <- "Datasets/Tanzania_2018_new-3.dta"
df <- read_dta(file_path)
# create below_pov: 1 if cons < povline, 0 otherwise
df$below_pov <- ifelse(df$cons < df$povline, 1, 0)
# add variable to dataset
write_dta(df, file_path)
View(Tanzania_2018_new_3)
file_path <- "Datasets/Tanzania_2018_new-3.dta"
df <- read_dta(file_path)
# create below_pov: 1 if cons < povline, 0 otherwise
df$below_pov <- ifelse(df$cons < df$povline, 1L, 0L)
# add variable to dataset
write_dta(df, file_path)
file_path <- "Datasets/Tanzania_2018_new-3.dta"
df <- read_dta(file_path)
# create below_pov: 1 if cons < povline, 0 otherwise
df$below_pov <- ifelse(df$cons < df$povline, 1, 0)
# write back (overwrite)
write_dta(df, file_path)
# verify: read back and print a short confirmation
df_check <- read_dta(file_path)
cat("Wrote file:", file_path, "\n")
cat("Variable present?:", "below_pov" %in% names(df_check), "\n")
if ("below_pov" %in% names(df_check)) {
cat("Non-missing / missing counts:", sum(!is.na(df_check$below_pov)), "/", sum(is.na(df_check$below_pov)), "\n")
print(head(df_check$below_pov, 10))
}
rm(list = ls())
file_path <- "Datasets/Tanzania_2018_new-3.dta"
if (!file.exists(file_path)) stop("File not found: ", file_path)
# read
df <- read_dta(file_path)
# create below_pov: 1 if cons < povline, 0 if cons >= povline
df$below_pov <- ifelse(df$cons < df$povline, 1L, 0L)
# write back (overwrite)
write_dta(df, file_path)
View(df)
file_path <- "Datasets/Tanzania_2018_new-3.dta"
# read
Tanzania_2018_below_pov <- read_dta(file_path)
# create below_pov: 1 if cons < povline, 0 if cons >= povline
Tanzania_2018_below_pov$below_pov <- ifelse(Tanzania_2018_below_pov$cons < Tanzania_2018_below_pov$povline, 1, 0)
# write back (overwrite)
write_dta(Tanzania_2018_below_pov, file_path)
View(Tanzania_2018_below_pov)
# below-poverty households and valid observations in age 7-18
sel <- (Tanzania_2018_below_pov$cons < Tanzania_2018_below_pov$povline) & !is.na(Tanzania_2018_below_pov$inschool) & !is.na(Tanzania_2018_below_pov$male) & !is.na(Tanzania_2018_below_pov$rural) & !is.na(Tanzania_2018_below_pov$age) & Tanzania_2018_below_pov$age >= 7 & Tanzania_2018_below_pov$age <= 18
Tanzania_2018_below_pov <- Tanzania_2018_below_pov[sel, , drop = FALSE]
# create age group variable
Tanzania_2018_below_pov$agegrp <- ifelse(Tanzania_2018_below_pov$age >= 7 & Tanzania_2018_below_pov$age <= 12, "7-12", "13-18")
# survey design using household weight
svy <- svydesign(id = ~1, weights = ~hhweight, data = Tanzania_2018_below_pov)
# weighted mean of inschool by rural + male + agegrp
res <- svyby(~inschool, ~rural + male + agegrp, svy, svymean, na.rm = TRUE)
# identify estimate and se columns robustly
group_cols <- c("rural","male","agegrp")
est_col <- setdiff(names(res), group_cols)[1]
se_col_candidates <- grep(paste0("^", est_col, "(_se|\\.se$|__se$)"), names(res), value = TRUE)
if (length(se_col_candidates) == 0) se_col_candidates <- grep("(_se$|\\.se$|se$)", names(res), value = TRUE)
se_col <- if (length(se_col_candidates) > 0) se_col_candidates[1] else NA
# build result frame and labels
res_df <- data.frame(
rural = res$rural,
male = res$male,
agegrp = res$agegrp,
estimate = res[[est_col]],
se = if (!is.na(se_col)) res[[se_col]] else NA_real_,
stringsAsFactors = FALSE
)
# map codes to readable labels
res_df$location <- ifelse(res_df$rural %in% c(1, "1", TRUE), "rural", "urban")
res_df$sex_label <- ifelse(res_df$male %in% c(1, "1", TRUE), "Male", "Female")
res_df$percent <- 100 * res_df$estimate
res_df$se_pct  <- 100 * res_df$se
res_df$display <- ifelse(is.na(res_df$percent), NA, sprintf("%.1f (±%.1f)", res_df$percent, res_df$se_pct))
# create column name combining sex and age group, then pivot wide (base R)
res_df$colname <- paste(res_df$sex_label, res_df$agegrp)
wide <- reshape(res_df[, c("location","colname","display")],
idvar = "location", timevar = "colname", direction = "wide")
names(wide) <- sub("^display\\.", "", names(wide))
# ensure order: urban then rural (rural variable uses 0 = urban, 1 = rural)
order_pref <- c("urban","rural")
wide$location <- factor(wide$location, levels = order_pref)
wide <- wide[order(wide$location, na.last = TRUE), , drop = FALSE]
# replace NA with "-"
wide[is.na(wide)] <- "-"
# print table
print(wide, row.names = FALSE)
if (interactive()) View(wide)
View(res_df)
# keep observations with treatment and outcome
Tanzania_2018_below_pov <- subset(Tanzania_2018_below_pov, !is.na(freebooks) & !is.na(inschool_later))
# survey design: use STRATUM if present, otherwise unstratified
if ("STRATUM" %in% names(Tanzania_2018_below_pov)) {
svy <- svydesign(id = ~1, strata = ~STRATUM, weights = ~hhweight, data = Tanzania_2018_below_pov)
} else {
svy <- svydesign(id = ~1, weights = ~hhweight, data = Tanzania_2018_below_pov)
}
# group means (proportions) by freebooks (0 = control, 1 = treatment)
grp <- svyby(~inschool_later, ~freebooks, svy, svymean, na.rm = TRUE)
# difference in means via linear survey regression (identity link)
fit <- svyglm(inschool_later ~ freebooks, design = svy, family = gaussian())
s <- summary(fit)
# extract numbers
control_mean <- as.numeric(grp$inschool_later[grp$freebooks == 0])
treat_mean   <- as.numeric(grp$inschool_later[grp$freebooks == 1])
diff_est     <- coef(fit)["freebooks"]
diff_se      <- s$coef["freebooks","Std. Error"]
diff_p       <- s$coef["freebooks","Pr(>|t|)"]
# prepare and print compact table
tab <- data.frame(
group = c("Control (freebooks=0)", "Treatment (freebooks=1)", "Difference (T - C)"),
proportion = c(control_mean, treat_mean, diff_est),
se = c(NA, NA, diff_se),
p_value = c(NA, NA, diff_p),
stringsAsFactors = FALSE
)
tab$percent <- round(100 * tab$proportion, 2)
tab$se_pct  <- ifelse(is.na(tab$se), NA, round(100 * tab$se, 2))
cat("\nEffect of free books on later enrollment (inschool_later) — Tanzania_2018_new-3.dta\n")
print(tab[, c("group","percent","se_pct","p_value")], row.names = FALSE)
# keep observations with treatment and outcome
Tanzania_2018_below_pov <- subset(Tanzania_2018_below_pov, !is.na(freebooks) & !is.na(inschool_later))
# survey design: use STRATUM
svy <- svydesign(id = ~1, strata = ~STRATUM, weights = ~hhweight, data = Tanzania_2018_below_pov)
# group means (proportions) by free books (0 = control, 1 = treatment)
grp <- svyby(~inschool_later, ~freebooks, svy, svymean, na.rm = TRUE)
# difference in means via linear survey regression (identity link)
fit <- svyglm(inschool_later ~ freebooks, design = svy, family = gaussian())
s <- summary(fit)
# extract numbers
control_mean <- as.numeric(grp$inschool_later[grp$freebooks == 0])
treat_mean   <- as.numeric(grp$inschool_later[grp$freebooks == 1])
diff_est     <- coef(fit)["freebooks"]
diff_se      <- s$coef["freebooks","Std. Error"]
diff_p       <- s$coef["freebooks","Pr(>|t|)"]
# prepare and print compact table
tab <- data.frame(
group = c("Control (freebooks=0)", "Treatment (freebooks=1)", "Difference (T - C)"),
proportion = c(control_mean, treat_mean, diff_est),
se = c(NA, NA, diff_se),
p_value = c(NA, NA, diff_p),
stringsAsFactors = FALSE
)
tab$percent <- round(100 * tab$proportion, 2)
tab$se_pct  <- ifelse(is.na(tab$se), NA, round(100 * tab$se, 2))
cat("\nEffect of free books on later enrollment (inschool_later) — Tanzania_2018_new-3.dta\n")
print(tab[, c("group","percent","se_pct","p_value")], row.names = FALSE)
# below-poverty households and valid observations in age 7-18
sel <- (Tanzania_2018_below_pov$cons < Tanzania_2018_below_pov$povline) & !is.na(Tanzania_2018_below_pov$inschool) & !is.na(Tanzania_2018_below_pov$male) & !is.na(Tanzania_2018_below_pov$rural) & !is.na(Tanzania_2018_below_pov$age) & Tanzania_2018_below_pov$age >= 7 & Tanzania_2018_below_pov$age <= 18
Tanzania_2018_below_pov <- Tanzania_2018_below_pov[sel, , drop = FALSE]
# create age group variable
Tanzania_2018_below_pov$agegrp <- ifelse(Tanzania_2018_below_pov$age >= 7 & Tanzania_2018_below_pov$age <= 12, "7-12", "13-18")
# survey design using household weight
svy <- svydesign(id = ~1, weights = ~hhweight, data = Tanzania_2018_below_pov)
# weighted mean of inschool by rural + male + agegrp
res <- svyby(~inschool, ~rural + male + agegrp, svy, svymean, na.rm = TRUE)
# identify estimate and se columns robustly
group_cols <- c("rural","male","agegrp")
est_col <- setdiff(names(res), group_cols)[1]
se_col_candidates <- grep(paste0("^", est_col, "(_se|\\.se$|__se$)"), names(res), value = TRUE)
if (length(se_col_candidates) == 0) se_col_candidates <- grep("(_se$|\\.se$|se$)", names(res), value = TRUE)
se_col <- if (length(se_col_candidates) > 0) se_col_candidates[1] else NA
# build result frame and labels
res_df <- data.frame(
rural = res$rural,
male = res$male,
agegrp = res$agegrp,
estimate = res[[est_col]],
se = if (!is.na(se_col)) res[[se_col]] else NA_real_,
stringsAsFactors = FALSE
)
# map codes to readable labels
res_df$location <- ifelse(res_df$rural %in% c(1, "1", TRUE), "rural", "urban")
res_df$sex_label <- ifelse(res_df$male %in% c(1, "1", TRUE), "Male", "Female")
res_df$percent <- 100 * res_df$estimate
res_df$se_pct  <- 100 * res_df$se
res_df$display <- ifelse(is.na(res_df$percent), NA, sprintf("%.1f (±%.1f)", res_df$percent, res_df$se_pct))
# create column name combining sex and age group
res_df$colname <- paste(res_df$sex_label, res_df$agegrp)
wide <- reshape(res_df[, c("location","colname","display")],
idvar = "location", timevar = "colname", direction = "wide")
names(wide) <- sub("^display\\.", "", names(wide))
# ensure order: urban then rural (rural variable uses 0 = urban, 1 = rural)
order_pref <- c("urban","rural")
wide$location <- factor(wide$location, levels = order_pref)
wide <- wide[order(wide$location, na.last = TRUE), , drop = FALSE]
# print table
print(wide, row.names = FALSE)
View(wide)
# below-poverty households and valid observations in age 7-18
sel <- (Tanzania_2018_below_pov$cons < Tanzania_2018_below_pov$povline) & !is.na(Tanzania_2018_below_pov$inschool) & !is.na(Tanzania_2018_below_pov$male) & !is.na(Tanzania_2018_below_pov$rural) & !is.na(Tanzania_2018_below_pov$age) & Tanzania_2018_below_pov$age >= 7 & Tanzania_2018_below_pov$age <= 18
Tanzania_2018_below_pov <- Tanzania_2018_below_pov[sel, , drop = FALSE]
# create age group variable
Tanzania_2018_below_pov$agegrp <- ifelse(Tanzania_2018_below_pov$age >= 7 & Tanzania_2018_below_pov$age <= 12, "7-12", "13-18")
# survey design using household weight
svy <- svydesign(id = ~1, weights = ~hhweight, data = Tanzania_2018_below_pov)
# weighted mean of inschool by rural + male + agegrp
res <- svyby(~inschool, ~rural + male + agegrp, svy, svymean, na.rm = TRUE)
# identify estimate and se columns robustly
group_cols <- c("rural","male","agegrp")
est_col <- setdiff(names(res), group_cols)[1]
se_col_candidates <- grep(paste0("^", est_col, "(_se|\\.se$|__se$)"), names(res), value = TRUE)
if (length(se_col_candidates) == 0) se_col_candidates <- grep("(_se$|\\.se$|se$)", names(res), value = TRUE)
se_col <- if (length(se_col_candidates) > 0) se_col_candidates[1] else NA
# build result frame and labels
res_df <- data.frame(
rural = res$rural,
male = res$male,
agegrp = res$agegrp,
estimate = res[[est_col]],
se = if (!is.na(se_col)) res[[se_col]] else NA_real_,
stringsAsFactors = FALSE
)
wide <- res_df %>%
mutate(
# map codes to readable labels (rural: 1 => "rural", else "urban")
location = if_else(rural %in% c(1, "1", TRUE), "rural", "urban"),
sex = if_else(male %in% c(1, "1", TRUE), "Male", "Female"),
# percent and se in percentage points
percent = 100 * estimate,
se_pct  = 100 * se,
# formatted display string, NA preserved
display = if_else(is.na(percent), NA_character_, sprintf("%.1f (±%.1f)", percent, se_pct)),
# combined column name
colname = paste(sex, agegrp)
) %>%
select(location, colname, display) %>%
pivot_wider(names_from = colname, values_from = display) %>%
# ensure order: urban then rural
mutate(location = factor(location, levels = c("urban", "rural"))) %>%
arrange(location)
# replace NA displays with "-" for readability
wide[is.na(wide)] <- "-"
# print result
print(wide, row.names = FALSE)
View(wide)
print(wide)
# keep observations with treatment and outcome
Tanzania_2018_below_pov <- subset(Tanzania_2018_below_pov, !is.na(freebooks) & !is.na(inschool_later))
# survey design: use STRATUM
svy <- svydesign(id = ~1, strata = ~STRATUM, weights = ~hhweight, data = Tanzania_2018_below_pov)
# group means (proportions) by free books (0 = control, 1 = treatment)
grp <- svyby(~inschool_later, ~freebooks, svy, svymean, na.rm = TRUE)
# difference in means via linear survey regression
fit <- svyglm(inschool_later ~ freebooks, design = svy, family = gaussian())
s <- summary(fit)
# extract numbers
control_mean <- as.numeric(grp$inschool_later[grp$freebooks == 0])
treat_mean   <- as.numeric(grp$inschool_later[grp$freebooks == 1])
diff_est     <- coef(fit)["freebooks"]
diff_se      <- s$coef["freebooks","Std. Error"]
diff_p       <- s$coef["freebooks","Pr(>|t|)"]
# prepare and print compact table
tab <- data.frame(
group = c("Control (freebooks=0)", "Treatment (freebooks=1)", "Difference (T - C)"),
proportion = c(control_mean, treat_mean, diff_est),
se = c(NA, NA, diff_se),
p_value = c(NA, NA, diff_p),
stringsAsFactors = FALSE
)
tab$percent <- round(100 * tab$proportion, 2)
tab$se_pct  <- ifelse(is.na(tab$se), NA, round(100 * tab$se, 2))
cat("\nEffect of free books on later enrollment (inschool_later) — Tanzania_2018_new-3.dta\n")
print(tab[, c("group","percent","se_pct","p_value")], row.names = FALSE)
View(fit)
print(tab[, c("group","percent","se_pct","p_value")])
mean(Tanzania_2018_below_pov$below_pov) * 100
file_path <- "Datasets/Tanzania_2018_new-3.dta"
# read
Tanzania_2018_below_pov <- read_dta(file_path)
# create below_pov: 1 if cons < povline, 0 if cons >= povline
Tanzania_2018_below_pov$below_pov <- ifelse(Tanzania_2018_below_pov$cons < Tanzania_2018_below_pov$povline, 1, 0)
# write back (overwrite)
write_dta(Tanzania_2018_below_pov, file_path)
mean(Tanzania_2018_below_pov$below_pov) * 100
